// Generated by CoffeeScript 1.6.2
(function() {
  var click_add_btn, click_delete, click_sort_btn, click_toggle_details, delete_task, display_sorted_tasks, edit_title, highlight_column, init_all, init_delete_btns, init_details_display, init_edit, init_once, init_sort, init_toggle_details_btn, key_title, on_ajax_error, prepend_task, save_due_date, save_is_completed, save_priority, save_title, set_details_btn_text, set_sort_btn_imgs, set_sort_state, sort_tasks_by, state, update_task;

  on_ajax_error = function(jqXHR, textStatus, errorThrown) {
    console.log(textStatus);
    console.log(errorThrown);
    return console.log(jqXHR);
  };

  state = {
    details_showing: true,
    sort: {
      column: 'priority',
      is_asc: {
        title: true,
        due_date: true,
        priority: false,
        is_completed: true
      }
    }
  };

  display_sorted_tasks = function(htmlStr, textStatus, jqXHR) {
    $('#tasks_container').html(htmlStr);
    highlight_column(state.sort.column);
    init_delete_btns();
    init_details_display();
    return init_edit(null);
  };

  sort_tasks_by = function(attr, is_asc) {
    return $.ajax({
      url: '/kaseres/tasks/',
      type: 'GET',
      data: {
        sort_attr: attr,
        sort_is_asc: is_asc
      },
      cache: false,
      dataType: 'html',
      success: display_sorted_tasks,
      error: function() {
        return on_ajax_error;
      }
    });
  };

  set_sort_state = function(attr) {
    var s;

    s = state.sort;
    if (s.column === attr) {
      return s.is_asc[attr] = !s.is_asc[attr];
    } else {
      return s.column = attr;
    }
  };

  set_sort_btn_imgs = function(attr) {
    var dir;

    $('.sort_arrow').hide();
    dir = state.sort.is_asc[attr] ? 'up' : 'dn';
    return $("#" + dir + "_arrow_" + attr).show();
  };

  highlight_column = function(attr) {
    return $(".attr." + attr).addClass('highlighted');
  };

  click_sort_btn = function(evt) {
    var attr;

    attr = this.id.match(/^sort_(.+)$/)[1];
    set_sort_state(attr);
    sort_tasks_by(attr, state.sort.is_asc[attr]);
    set_sort_btn_imgs(attr);
    return highlight_column(attr);
  };

  init_sort = function() {
    $('.sort_btn').click(click_sort_btn);
    set_sort_btn_imgs(state.sort.column);
    return highlight_column(state.sort.column);
  };

  update_task = function(task_id, attr, old_val, new_val) {
    var data;

    if (new_val === old_val) {
      return;
    }
    if (state.sort.column === attr) {
      $("#task_" + attr + "_" + task_id).removeClass('highlighted');
    }
    data = {};
    data[attr] = new_val;
    return $.ajax({
      type: 'POST',
      url: "/kaseres/tasks/" + task_id + "/update/",
      data: data,
      dataType: 'html',
      cache: false,
      error: on_ajax_error,
      success: function() {
        return console.log('saved!');
      }
    });
  };

  save_title = function(evt) {
    var new_title;

    new_title = $.trim($(this).val());
    $("#task_title_" + evt.data.task_id).html(new_title).click(edit_title);
    return update_task(evt.data.task_id, 'title', evt.data.prev_title, new_title);
  };

  edit_title = function() {
    var input_html, prev_title, task_id;

    $(this).unbind();
    task_id = this.id.match(/^task_title_(\d+)$/)[1];
    prev_title = $.trim($(this).html());
    input_html = "<input type='text' id='temp_edit' value='" + prev_title + "' size='60' />";
    $(this).html(input_html);
    return $('#temp_edit').focus().blur({
      task_id: task_id,
      prev_title: prev_title
    }, save_title).keypress(key_title);
  };

  key_title = function(evt) {
    if (evt.which === 13) {
      return $(this).blur();
    }
  };

  save_priority = function() {
    var new_val, task_id;

    new_val = $(this).val();
    task_id = this.id.match(/^task_priority_select_(\d+)$/)[1];
    return update_task(task_id, 'priority', null, new_val);
  };

  save_is_completed = function() {
    var new_val, task_id;

    new_val = $(this).is(':checked');
    task_id = this.id.match(/^task_is_completed_checkbox_(\d+)$/)[1];
    return update_task(task_id, 'is_completed', null, new_val);
  };

  save_due_date = function() {
    var new_val, task_id;

    new_val = $(this).val();
    task_id = this.id.match(/^task_due_date_input_(\d+)$/)[1];
    return update_task(task_id, 'due_date', null, new_val);
  };

  init_edit = function(task_id) {
    var ancestor;

    ancestor = task_id === null ? '' : "#task_" + task_id + " ";
    $("" + ancestor + ".attr.title").click(edit_title);
    $("" + ancestor + ".task_priority_select").change(save_priority);
    $("" + ancestor + ".task_is_completed_checkbox").change(save_is_completed);
    $("" + ancestor + ".task_due_date_input").change(save_due_date);
    return $("" + ancestor + ".task_due_date_input").datepicker({
      dateFormat: 'MM d, yy'
    });
  };

  prepend_task = function(html_str, text_status, jqXHR) {
    var task_id;

    task_id = html_str.match(/^<li id=\"task_(\d+)\"/)[1];
    $('#tasks').prepend(html_str);
    $("#delete_" + task_id).click(click_delete);
    init_edit(task_id);
    $("#task_details_" + task_id).hide();
    return $("#task_title_" + task_id).click();
  };

  click_add_btn = function() {
    return $.ajax({
      type: 'POST',
      url: '/kaseres/tasks/create/',
      data: {
        sort_attr: state.sort.column,
        sort_direction: state.sort.is_asc[state.sort.column],
        title: 'ADD TITLE',
        details: ''
      },
      dataType: 'html',
      cache: false,
      error: on_ajax_error,
      success: prepend_task
    });
  };

  delete_task = function(id) {
    return $.ajax({
      type: 'DELETE',
      url: "/kaseres/tasks/" + id + "/delete/",
      cache: false,
      error: on_ajax_error,
      success: function() {
        return console.log('success!');
      }
    });
  };

  click_delete = function(evt) {
    var elem, task_id;

    if (!confirm('Delete this task?')) {
      return;
    }
    task_id = this.id.match(/^delete_(.*)$/)[1];
    elem = $("#task_" + task_id);
    elem.toggle(200, function() {
      return elem.remove();
    });
    return delete_task(task_id);
  };

  init_delete_btns = function() {
    return $('.delete_btn').click(click_delete);
  };

  set_details_btn_text = function() {
    var verb;

    verb = state.details_showing ? 'Hide' : 'Show';
    return $('#toggle_details').html(verb + ' Details');
  };

  click_toggle_details = function(evt) {
    $('.task_details').toggle(200);
    state.details_showing = !state.details_showing;
    return set_details_btn_text();
  };

  init_details_display = function() {
    if (!state.details_showing) {
      return $('.task_details').toggle();
    }
  };

  init_toggle_details_btn = function() {
    $('#toggle_details').click(click_toggle_details);
    set_details_btn_text();
    return init_details_display();
  };

  init_once = function() {
    init_toggle_details_btn();
    return $('#add_task').click(click_add_btn);
  };

  init_all = function() {
    init_sort();
    init_once();
    init_delete_btns();
    return init_edit(null);
  };

  $(document).ready(init_all);

}).call(this);
